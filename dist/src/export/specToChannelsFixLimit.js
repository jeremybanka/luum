"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const filters_1 = require("../constants/filters");
const hueToRelativeChannels_1 = __importDefault(require("../import/hueToRelativeChannels"));
const solveFor_1 = require("../solveFor");
const utils_1 = require("../utils");
const minChannelsForSaturationFromHue = (hue) => {
    const relativeChannels = (0, hueToRelativeChannels_1.default)(hue);
    const channelSpreader = (trueSaturation) => {
        const makeMinChannel = (idx) => Math.round(relativeChannels[idx] * trueSaturation);
        return {
            R: makeMinChannel(0),
            G: makeMinChannel(1),
            B: makeMinChannel(2),
        };
    };
    return channelSpreader;
};
const channelsFromIlluminationObj = ({ minChannels, trueLuminosity, minLum, }) => {
    const { max, round } = Math;
    const maxWhite = 255 - max(...Object.values(minChannels));
    const white = (0, utils_1.clamp)(round((trueLuminosity - minLum) * 255), [0, maxWhite]);
    const channels = {
        R: minChannels.R + white,
        G: minChannels.G + white,
        B: minChannels.B + white,
    };
    return channels;
};
const specToChannelsFixLimit = ({ hue, sat, lum, prefer = `lum` }, filter = filters_1.unfiltered) => {
    const minChannelsForSaturation = minChannelsForSaturationFromHue(hue);
    let trueSaturation;
    let trueLuminosity;
    let minChannels;
    let maxChannels;
    let specificLum;
    let minLum = 0;
    let maxLum = 1;
    let maxSat = (0, solveFor_1.maxSatForHueInFilter)(hue, filter);
    switch (prefer) {
        case `sat`:
            trueSaturation = (0, utils_1.clamp)(Math.min(sat, maxSat), [0, 255]);
            minChannels = minChannelsForSaturation(trueSaturation);
            maxChannels = {
                R: minChannels.R + 255 - trueSaturation,
                G: minChannels.G + 255 - trueSaturation,
                B: minChannels.B + 255 - trueSaturation,
            };
            minLum = (0, solveFor_1.lumFromChannels)(minChannels);
            maxLum = (0, solveFor_1.lumFromChannels)(maxChannels);
            trueLuminosity = (0, utils_1.clamp)(lum, [minLum, maxLum]);
            break;
        case `lum`:
            trueLuminosity = (0, utils_1.clamp)(lum, [0, 1]);
            specificLum = (0, solveFor_1.specificLumFromHue)(hue);
            maxSat = Math.min(maxSat, Math.round(trueLuminosity <= specificLum
                ? 255 * (trueLuminosity / specificLum)
                : (255 * (1 - trueLuminosity)) / (1 - specificLum)));
            trueSaturation = Math.min(sat, maxSat);
            minChannels = minChannelsForSaturation(trueSaturation);
            minLum = (0, solveFor_1.lumFromChannels)(minChannels);
            break;
    }
    const channels = channelsFromIlluminationObj({
        minChannels,
        trueLuminosity,
        minLum,
    });
    return {
        channels,
        fix: {
            sat: trueSaturation,
            lum: trueLuminosity,
        },
        limit: {
            sat: [0, maxSat],
            lum: [prefer === `lum` ? 0 : minLum, maxLum],
        },
    };
};
exports.default = specToChannelsFixLimit;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3BlY1RvQ2hhbm5lbHNGaXhMaW1pdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9leHBvcnQvc3BlY1RvQ2hhbm5lbHNGaXhMaW1pdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQVVBLGtEQUFpRDtBQUNqRCw0RkFBbUU7QUFDbkUsMENBSW9CO0FBQ3BCLG9DQUFnQztBQUVoQyxNQUFNLCtCQUErQixHQUFHLENBQUMsR0FBVyxFQUFFLEVBQUU7SUFDdEQsTUFBTSxnQkFBZ0IsR0FBRyxJQUFBLCtCQUFxQixFQUFDLEdBQUcsQ0FBQyxDQUFBO0lBQ25ELE1BQU0sZUFBZSxHQUFHLENBQUMsY0FBd0IsRUFBaUIsRUFBRTtRQUNsRSxNQUFNLGNBQWMsR0FBRyxDQUFDLEdBQVcsRUFBRSxFQUFFLENBQ3JDLElBQUksQ0FBQyxLQUFLLENBQUMsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLEdBQUcsY0FBYyxDQUFDLENBQUE7UUFDcEQsT0FBTztZQUNMLENBQUMsRUFBRSxjQUFjLENBQUMsQ0FBQyxDQUFDO1lBQ3BCLENBQUMsRUFBRSxjQUFjLENBQUMsQ0FBQyxDQUFDO1lBQ3BCLENBQUMsRUFBRSxjQUFjLENBQUMsQ0FBQyxDQUFDO1NBQ3JCLENBQUE7SUFDSCxDQUFDLENBQUE7SUFDRCxPQUFPLGVBQWUsQ0FBQTtBQUN4QixDQUFDLENBQUE7QUFRRCxNQUFNLDJCQUEyQixHQUFHLENBQUMsRUFDbkMsV0FBVyxFQUNYLGNBQWMsRUFDZCxNQUFNLEdBQ1UsRUFBaUIsRUFBRTtJQUNuQyxNQUFNLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBRSxHQUFHLElBQUksQ0FBQTtJQUMzQixNQUFNLFFBQVEsR0FBRyxHQUFHLEdBQUcsR0FBRyxDQUFDLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFBO0lBQ3pELE1BQU0sS0FBSyxHQUFHLElBQUEsYUFBSyxFQUFDLEtBQUssQ0FBQyxDQUFDLGNBQWMs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Q1gsY0FBYztRQUNkLE1BQU07S0FDUCxDQUFDLENBQUE7SUFFRixPQUFPO1FBQ0wsUUFBUTtRQUNSLEdBQUcsRUFBRTtZQUNILEdBQUcsRUFBRSxjQUFjO1lBQ25CLEdBQUcsRUFBRSxjQUFjO1NBQ3BCO1FBQ0QsS0FBSyxFQUFFO1lBQ0wsR0FBRyxFQUFFLENBQUMsQ0FBQyxFQUFFLE1BQU0sQ0FBQztZQUNoQixHQUFHLEVBQUUsQ0FBQyxNQUFNLEtBQUssS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sRUFBRSxNQUFNLENBQUM7U0FDN0M7S0FDRixDQUFBO0FBQ0gsQ0FBQyxDQUFBO0FBRUQsa0JBQWUsc0JBQXNCLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgdHlwZSB7XG4gIENoYW5uZWxPYmplY3QsXG4gIERlZ3JlZSxcbiAgRmlsdGVyLFxuICBGcmFjdGlvbixcbiAgTHV1bVNwZWMsXG4gIE91dE9mMjU1LFxuICBSYW5nZSxcbn0gZnJvbSBcIn5cIlxuXG5pbXBvcnQgeyB1bmZpbHRlcmVkIH0gZnJvbSBcIi4uL2NvbnN0YW50cy9maWx0ZXJzXCJcbmltcG9ydCBodWVUb1JlbGF0aXZlQ2hhbm5lbHMgZnJvbSBcIi4uL2ltcG9ydC9odWVUb1JlbGF0aXZlQ2hhbm5lbHNcIlxuaW1wb3J0IHtcbiAgbHVtRnJvbUNoYW5uZWxzLFxuICBzcGVjaWZpY0x1bUZyb21IdWUsXG4gIG1heFNhdEZvckh1ZUluRmlsdGVyLFxufSBmcm9tIFwiLi4vc29sdmVGb3JcIlxuaW1wb3J0IHsgY2xhbXAgfSBmcm9tIFwiLi4vdXRpbHNcIlxuXG5jb25zdCBtaW5DaGFubmVsc0ZvclNhdHVyYXRpb25Gcm9tSHVlID0gKGh1ZTogRGVncmVlKSA9PiB7XG4gIGNvbnN0IHJlbGF0aXZlQ2hhbm5lbHMgPSBodWVUb1JlbGF0aXZlQ2hhbm5lbHMoaHVlKVxuICBjb25zdCBjaGFubmVsU3ByZWFkZXIgPSAodHJ1ZVNhdHVyYXRpb246IE91dE9mMjU1KTogQ2hhbm5lbE9iamVjdCA9PiB7XG4gICAgY29uc3QgbWFrZU1pbkNoYW5uZWwgPSAoaWR4OiBudW1iZXIpID0+XG4gICAgICBNYXRoLnJvdW5kKHJlbGF0aXZlQ2hhbm5lbHNbaWR4XSAqIHRydWVTYXR1cmF0aW9uKVxuICAgIHJldHVybiB7XG4gICAgICBSOiBtYWtlTWluQ2hhbm5lbCgwKSxcbiAgICAgIEc6IG1ha2VNaW5DaGFubmVsKDEpLFxuICAgICAgQjogbWFrZU1pbkNoYW5uZWwoMiksXG4gICAgfVxuICB9XG4gIHJldHVybiBjaGFubmVsU3ByZWFkZXJcbn1cblxudHlwZSBJbGx1bWluYXRpb25PYmogPSB7XG4gIG1pbkNoYW5uZWxzOiBDaGFubmVsT2JqZWN0XG4gIHRydWVMdW1pbm9zaXR5OiBudW1iZXJcbiAgbWluTHVtOiBudW1iZXJcbn1cblxuY29uc3QgY2hhbm5lbHNGcm9tSWxsdW1pbmF0aW9uT2JqID0gKHtcbiAgbWluQ2hhbm5lbHMsXG4gIHRydWVMdW1pbm9zaXR5LFxuICBtaW5MdW0sXG59OiBJbGx1bWluYXRpb25PYmopOiBDaGFubmVsT2JqZWN0ID0+IHtcbiAgY29uc3QgeyBtYXgsIHJvdW5kIH0gPSBNYXRoXG4gIGNvbnN0IG1heFdoaXRlID0gMjU1IC0gbWF4KC4uLk9iamVjdC52YWx1ZXMobWluQ2hhbm5lbHMpKVxuICBjb25zdCB3aGl0ZSA9IGNsYW1wKHJvdW5kKCh0cnVlTHVtaW5vc2l0eSAtIG1pbkx1bSkgKiAyNTUpLCBbMCwgbWF4V2hpdGVdKVxuICBjb25zdCBjaGFubmVscyA9IHtcbiAgICBSOiBtaW5DaGFubmVscy5SICsgd2hpdGUsXG4gICAgRzogbWluQ2hhbm5lbHMuRyArIHdoaXRlLFxuICAgIEI6IG1pbkNoYW5uZWxzLkIgKyB3aGl0ZSxcbiAgfVxuICByZXR1cm4gY2hhbm5lbHNcbn1cblxudHlwZSBTcGVjVG9DaGFubmVsc0ZpeExpbWl0ID0gKFxuICBzcGVjOiBMdXVtU3BlYyxcbiAgZmlsdGVyPzogRmlsdGVyXG4pID0+IHtcbiAgY2hhbm5lbHM6IENoYW5uZWxPYmplY3RcbiAgZml4OiB7IHNhdDogbnVtYmVyOyBsdW06IG51bWJlciB9XG4gIGxpbWl0OiB7IHNhdDogUmFuZ2U7IGx1bTogUmFuZ2UgfVxufVxuXG5jb25zdCBzcGVjVG9DaGFubmVsc0ZpeExpbWl0OiBTcGVjVG9DaGFubmVsc0ZpeExpbWl0ID0gKFxuICB7IGh1ZSwgc2F0LCBsdW0sIHByZWZlciA9IGBsdW1gIH0sXG4gIGZpbHRlciA9IHVuZmlsdGVyZWRcbikgPT4ge1xuICBjb25zdCBtaW5DaGFubmVsc0ZvclNhdHVyYXRpb24gPSBtaW5DaGFubmVsc0ZvclNhdHVyYXRpb25Gcm9tSHVlKGh1ZSlcblxuICBsZXQgdHJ1ZVNhdHVyYXRpb246IE91dE9mMjU1XG4gIGxldCB0cnVlTHVtaW5vc2l0eTogRnJhY3Rpb25cbiAgbGV0IG1pbkNoYW5uZWxzOiBDaGFubmVsT2JqZWN0XG4gIGxldCBtYXhDaGFubmVsczogQ2hhbm5lbE9iamVjdFxuICBsZXQgc3BlY2lmaWNMdW06IEZyYWN0aW9uXG4gIGxldCBtaW5MdW0gPSAwXG4gIGxldCBtYXhMdW0gPSAxXG4gIGxldCBtYXhTYXQgPSBtYXhTYXRGb3JIdWVJbkZpbHRlcihodWUsIGZpbHRlcilcblxuICBzd2l0Y2ggKHByZWZlcikge1xuICAgIGNhc2UgYHNhdGA6XG4gICAgICB0cnVlU2F0dXJhdGlvbiA9IGNsYW1wKE1hdGgubWluKHNhdCwgbWF4U2F0KSwgWzAsIDI1NV0pXG4gICAgICBtaW5DaGFubmVscyA9IG1pbkNoYW5uZWxzRm9yU2F0dXJhdGlvbih0cnVlU2F0dXJhdGlvbilcbiAgICAgIG1heENoYW5uZWxzID0ge1xuICAgICAgICBSOiBtaW5DaGFubmVscy5SICsgMjU1IC0gdHJ1ZVNhdHVyYXRpb24sXG4gICAgICAgIEc6IG1pbkNoYW5uZWxzLkcgKyAyNTUgLSB0cnVlU2F0dXJhdGlvbixcbiAgICAgICAgQjogbWluQ2hhbm5lbHMuQiArIDI1NSAtIHRydWVTYXR1cmF0aW9uLFxuICAgICAgfVxuICAgICAgbWluTHVtID0gbHVtRnJvbUNoYW5uZWxzKG1pbkNoYW5uZWxzKVxuICAgICAgbWF4THVtID0gbHVtRnJvbUNoYW5uZWxzKG1heENoYW5uZWxzKVxuICAgICAgdHJ1ZUx1bWlub3NpdHkgPSBjbGFtcChsdW0sIFttaW5MdW0sIG1heEx1bV0pXG5cbiAgICAgIGJyZWFrXG4gICAgY2FzZSBgbHVtYDpcbiAgICAgIHRydWVMdW1pbm9zaXR5ID0gY2xhbXAobHVtLCBbMCwgMV0pXG4gICAgICBzcGVjaWZpY0x1bSA9IHNwZWNpZmljTHVtRnJvbUh1ZShodWUpXG4gICAgICBtYXhTYXQgPSBNYXRoLm1pbihcbiAgICAgICAgbWF4U2F0LFxuICAgICAgICBNYXRoLnJvdW5kKFxuICAgICAgICAgIHRydWVMdW1pbm9zaXR5IDw9IHNwZWNpZmljTHVtXG4gICAgICAgICAgICA/IDI1NSAqICh0cnVlTHVtaW5vc2l0eSAvIHNwZWNpZmljTHVtKVxuICAgICAgICAgICAgOiAoMjU1ICogKDEgLSB0cnVlTHVtaW5vc2l0eSkpIC8gKDEgLSBzcGVjaWZpY0x1bSlcbiAgICAgICAgKVxuICAgICAgKVxuICAgICAgdHJ1ZVNhdHVyYXRpb24gPSBNYXRoLm1pbihzYXQsIG1heFNhdClcbiAgICAgIG1pbkNoYW5uZWxzID0gbWluQ2hhbm5lbHNGb3JTYXR1cmF0aW9uKHRydWVTYXR1cmF0aW9uKVxuICAgICAgbWluTHVtID0gbHVtRnJvbUNoYW5uZWxzKG1pbkNoYW5uZWxzKVxuICAgICAgYnJlYWtcbiAgfVxuXG4gIGNvbnN0IGNoYW5uZWxzID0gY2hhbm5lbHNGcm9tSWxsdW1pbmF0aW9uT2JqKHtcbiAgICBtaW5DaGFubmVscyxcbiAgICB0cnVlTHVtaW5vc2l0eSxcbiAgICBtaW5MdW0sXG4gIH0pXG5cbiAgcmV0dXJuIHtcbiAgICBjaGFubmVscyxcbiAgICBmaXg6IHtcbiAgICAgIHNhdDogdHJ1ZVNhdHVyYXRpb24sXG4gICAgICBsdW06IHRydWVMdW1pbm9zaXR5LFxuICAgIH0sXG4gICAgbGltaXQ6IHtcbiAgICAgIHNhdDogWzAsIG1heFNhdF0sXG4gICAgICBsdW06IFtwcmVmZXIgPT09IGBsdW1gID8gMCA6IG1pbkx1bSwgbWF4THVtXSxcbiAgICB9LFxuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IHNwZWNUb0NoYW5uZWxzRml4TGltaXRcbiJdfQ==